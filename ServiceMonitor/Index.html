<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>服务器性能监控</title>
</head>
<body>
    <input type="button" value="开始监控" id="btnConnect" />
    <input type="button" value="停止监控" id="btnDisconnect" />
    <div id="container_cpu" style="height: 250px"></div>
    <div id="container_mem" style="height: 250px"></div>
    <script src="Scripts/jquery-1.6.4.min.js"></script>
    <script src="Scripts/echarts.simple.min.js"></script>
    <script src="Scripts/jquery.signalR-2.2.1.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="signalr/monitor/hubs"></script><!--与Startup中MapSignalR配置匹配-->
    <script type="text/javascript">
        var myChartCpu = echarts.init(document.getElementById('container_cpu'));
        var myChartMem = echarts.init(document.getElementById('container_mem'));
        var dateX = [];
        var valueCpu = [];
        var valueMem = [];
        var idx = 0;


        $(function () {
            myChartCpu.setOption({
                title: {
                    text: 'CPU占用率'
                },
                xAxis: {
                    type: 'category',
                    boundaryGap: false,
                    data: dateX
                },
                yAxis: {
                    boundaryGap: [0, '50%'],
                    type: 'value'
                },
                series: [
                    {
                        name: 'CPU',
                        type: 'line',
                        smooth: false,
                        data: valueCpu
                    }
                ]
            });

            myChartMem.setOption({
                title: {
                    text: '内存占用率'
                },
                xAxis: {
                    type: 'category',
                    boundaryGap: false,
                    data: dateX
                },
                yAxis: {
                    boundaryGap: [0, '50%'],
                    type: 'value'
                },
                series: [
                    {
                        name: 'Memory',
                        type: 'line',
                        data: valueMem
                    }
                ]
            });

            $('#btnConnect').click(function () {
                connectHub();
            });
            $('#btnDisconnect').click(function () {
                $.connection.hub.stop();
            });
        });

        function connectHub() {
            var monitor = $.connection.MonitorHub;//因为后台Hub中指定了HubName，这里直接使用HubName的值
            monitor.client.updateData = function (data) {
                //console.log(data);
                //return;

                updateChart(data);
                myChartCpu.setOption({
                    xAxis: {
                        data: dateX
                    },
                    series: [{
                        name: 'CPU使用率',
                        title: 'CPU',
                        data: valueCpu
                    }]
                });
                myChartMem.setOption({
                    xAxis: {
                        data: dateX
                    },
                    series: [
                    {
                        name: '内存使用率',
                        data: valueMem
                    }]
                });
            }
            $.connection.hub.start().done(function () {
                console.log('connected,connection id:' + $.connection.hub.id + ',transport:' + $.connection.hub.transport.name);
                monitor.server.CollectData();//因为后台Hub中指定了HubMethodName，这里直接使用HubMethodName的值
            });
        }

        function updateChart(data) {
            idx++;
            var time = new Date(data.Time);
            //console.log(time);
            time = [time.toLocaleTimeString()].join('/');
            dateX.push(time);
            valueCpu.push(parseFloat(data.CpuUsage));
            valueMem.push(parseFloat(data.MemoryUsage));
            if (idx >= 1000) {
                dateX.shift();
                valueCpu.shift();
                valueMem.shift();
            }
        }
    </script>
</body>
</html>
